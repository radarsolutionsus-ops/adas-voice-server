<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - ADAS F1RST Tech Portal</title>
  <link rel="stylesheet" href="/css/apple-style.css">
  <link rel="stylesheet" href="/css/portal.css">
  <style>
    /* Simplified Tech Portal Styles */
    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .dashboard-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary, #1d1d1f);
    }

    .tech-name {
      font-size: 15px;
      color: var(--text-secondary, #86868b);
      margin-top: 4px;
    }

    /* Section Styles */
    .section {
      margin-bottom: 32px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      cursor: pointer;
    }

    .section-header h2 {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary, #1d1d1f);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-count {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary, #86868b);
      background: var(--bg-grouped, #f2f2f7);
      padding: 4px 12px;
      border-radius: 12px;
    }

    .section-toggle {
      width: 24px;
      height: 24px;
      color: var(--text-tertiary, #aeaeb2);
      transition: transform 0.2s ease;
    }

    .section.collapsed .section-toggle {
      transform: rotate(-90deg);
    }

    .section.collapsed .section-content {
      display: none;
    }

    /* Subsection Styles */
    .subsection {
      margin-bottom: 24px;
    }

    .subsection-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .subsection-header h3 {
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary, #86868b);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .status-dot.red { background: #ff3b30; }
    .status-dot.blue { background: #007aff; }
    .status-dot.purple { background: #af52de; }
    .status-dot.green { background: #34c759; }
    .status-dot.orange { background: #ff9500; }
    .status-dot.gray { background: #8e8e93; }

    /* Job Card Styles */
    .job-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .job-row {
      display: flex;
      align-items: center;
      padding: 16px;
      background: #fff;
      border: 1px solid var(--border-subtle, rgba(0, 0, 0, 0.06));
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .job-row:hover {
      background: var(--bg-grouped, #f2f2f7);
      border-color: var(--border, rgba(0, 0, 0, 0.1));
    }

    .job-row.needs-action {
      border-left: 3px solid #ff3b30;
    }

    .job-row.scheduled {
      border-left: 3px solid #007aff;
    }

    .job-row.in-progress {
      border-left: 3px solid #af52de;
    }

    .job-row.completed {
      border-left: 3px solid #34c759;
    }

    .job-row.view-only {
      opacity: 0.7;
      border-left: 3px solid #8e8e93;
    }

    .job-row.view-only:hover {
      opacity: 0.85;
    }

    .job-status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 16px;
      flex-shrink: 0;
    }

    .job-status-indicator.red { background: #ff3b30; }
    .job-status-indicator.blue { background: #007aff; }
    .job-status-indicator.purple { background: #af52de; }
    .job-status-indicator.green { background: #34c759; }
    .job-status-indicator.orange { background: #ff9500; }
    .job-status-indicator.gray { background: #8e8e93; }

    .job-info {
      flex: 1;
      min-width: 0;
    }

    .job-ro {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary, #1d1d1f);
      margin-bottom: 4px;
    }

    .job-details {
      font-size: 14px;
      color: var(--text-secondary, #86868b);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .job-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      margin-left: 16px;
    }

    .job-time {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary, #86868b);
    }

    .job-badge {
      font-size: 12px;
      font-weight: 500;
      padding: 4px 10px;
      border-radius: 6px;
    }

    .job-badge.needs-revv {
      background: rgba(255, 59, 48, 0.1);
      color: #ff3b30;
    }

    .job-badge.scheduled {
      background: rgba(0, 122, 255, 0.1);
      color: #007aff;
    }

    .job-badge.in-progress {
      background: rgba(175, 82, 222, 0.1);
      color: #af52de;
    }

    .job-badge.completed {
      background: rgba(52, 199, 89, 0.1);
      color: #34c759;
    }

    .job-badge.view-only {
      background: rgba(142, 142, 147, 0.1);
      color: #8e8e93;
    }

    .job-arrow {
      width: 16px;
      height: 16px;
      color: var(--text-tertiary, #aeaeb2);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: var(--text-secondary, #86868b);
    }

    .empty-state .icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 12px;
      color: var(--text-tertiary, #aeaeb2);
    }

    .empty-state p {
      font-size: 15px;
    }

    /* All Jobs Section (collapsible) */
    .all-jobs-section {
      background: var(--bg-grouped, #f2f2f7);
      border-radius: 16px;
      padding: 20px;
    }

    .all-jobs-section .section-header {
      margin-bottom: 0;
    }

    .all-jobs-section.expanded .section-header {
      margin-bottom: 16px;
    }

    .all-jobs-section .section-content {
      display: none;
    }

    .all-jobs-section.expanded .section-content {
      display: block;
    }

    .view-only-note {
      font-size: 13px;
      color: var(--text-tertiary, #aeaeb2);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Header Styles */
    .simple-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: #fff;
      border-bottom: 1px solid var(--border-subtle, rgba(0, 0, 0, 0.06));
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 16px;
    }

    .logo-text {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary, #1d1d1f);
    }

    .btn-logout {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary, #86868b);
      background: var(--bg-grouped, #f2f2f7);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn-logout:hover {
      background: var(--bg, #e5e5ea);
      color: var(--text-primary, #1d1d1f);
    }

    .btn-logout .icon {
      width: 16px;
      height: 16px;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 560px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-subtle, rgba(0, 0, 0, 0.06));
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header h3 {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-grouped, #f2f2f7);
      border: none;
      border-radius: 50%;
      cursor: pointer;
    }

    .modal-close:hover {
      background: var(--bg, #e5e5ea);
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
    }

    .modal-section {
      margin-bottom: 24px;
    }

    .modal-section:last-child {
      margin-bottom: 0;
    }

    .modal-section h4 {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary, #86868b);
      margin-bottom: 8px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-subtle, rgba(0, 0, 0, 0.06));
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      font-size: 14px;
      color: var(--text-secondary, #86868b);
    }

    .info-value {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary, #1d1d1f);
    }

    .info-value.mono {
      font-family: ui-monospace, monospace;
      font-size: 13px;
    }

    .calibrations-box {
      background: var(--bg-grouped, #f2f2f7);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      color: var(--text-primary, #1d1d1f);
    }

    .doc-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
    }

    .doc-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 12px 8px;
      background: var(--bg-grouped, #f2f2f7);
      border-radius: 8px;
      font-size: 12px;
      color: var(--text-secondary, #86868b);
      text-decoration: none;
      transition: all 0.15s ease;
    }

    .doc-item.available {
      color: var(--text-primary, #1d1d1f);
      cursor: pointer;
    }

    .doc-item.available:hover {
      background: var(--bg, #e5e5ea);
    }

    .doc-item .icon {
      width: 24px;
      height: 24px;
    }

    .doc-item.available .icon {
      color: #007aff;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
    }

    .action-buttons .btn {
      flex: 1;
      padding: 12px 16px;
      font-size: 15px;
      font-weight: 500;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.15s ease;
    }

    .action-buttons .btn .icon {
      width: 18px;
      height: 18px;
    }

    .btn-start {
      background: #af52de;
      color: white;
    }

    .btn-start:hover {
      background: #9b47c7;
    }

    .btn-complete {
      background: #34c759;
      color: white;
    }

    .btn-complete:hover {
      background: #2db84d;
    }

    .btn-disabled {
      background: var(--bg-grouped, #f2f2f7);
      color: var(--text-tertiary, #aeaeb2);
      cursor: not-allowed;
    }

    .view-only-banner {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: rgba(142, 142, 147, 0.1);
      border-radius: 8px;
      font-size: 14px;
      color: #8e8e93;
      margin-bottom: 16px;
    }

    .view-only-banner .icon {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    /* Loading */
    .loading {
      display: flex;
      justify-content: center;
      padding: 32px;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top-color: var(--primary, #007aff);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 640px) {
      .dashboard-container {
        padding: 16px;
      }

      .dashboard-title {
        font-size: 24px;
      }

      .job-row {
        padding: 12px;
      }

      .job-meta {
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
      }

      .action-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- Simple Header -->
  <header class="simple-header">
    <div class="header-logo">
      <div class="logo-icon">A</div>
      <span class="logo-text">ADAS F1RST</span>
    </div>
    <button class="btn-logout" id="logoutBtn">
      <span class="icon" id="logoutIcon"></span>
      Sign Out
    </button>
  </header>

  <div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <div>
        <h1 class="dashboard-title">Your Dashboard</h1>
        <p class="tech-name" id="techName">Loading...</p>
      </div>
    </div>

    <!-- YOUR JOBS Section -->
    <div class="section" id="yourJobsSection">
      <div class="section-header">
        <h2>
          <span class="status-dot blue"></span>
          Your Jobs
        </h2>
        <span class="section-count" id="yourJobsCount">0</span>
      </div>

      <div class="section-content" id="yourJobsContent">
        <!-- Needs RevvADAS -->
        <div class="subsection" id="needsRevvSection">
          <div class="subsection-header">
            <span class="status-dot red"></span>
            <h3>Needs RevvADAS Report</h3>
          </div>
          <div class="job-list" id="needsRevvList">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </div>

        <!-- Today's Schedule -->
        <div class="subsection" id="todaySection">
          <div class="subsection-header">
            <span class="status-dot blue"></span>
            <h3>Today's Schedule</h3>
          </div>
          <div class="job-list" id="todayList">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </div>

        <!-- In Progress -->
        <div class="subsection" id="inProgressSection">
          <div class="subsection-header">
            <span class="status-dot purple"></span>
            <h3>In Progress</h3>
          </div>
          <div class="job-list" id="inProgressList">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ALL JOBS Section (Collapsed by default) -->
    <div class="section all-jobs-section" id="allJobsSection">
      <div class="section-header" onclick="toggleAllJobs()">
        <h2>
          <span class="status-dot gray"></span>
          All Jobs
        </h2>
        <div style="display:flex;align-items:center;gap:12px;">
          <span class="section-count" id="allJobsCount">0</span>
          <span class="section-toggle" id="allJobsToggle"></span>
        </div>
      </div>
      <div class="section-content" id="allJobsContent">
        <p class="view-only-note">
          <span class="icon" id="viewOnlyIcon"></span>
          Jobs assigned to other technicians (view only)
        </p>
        <div class="job-list" id="allJobsList">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Job Detail Modal -->
  <div class="modal-overlay" id="jobModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle">RO #---</h3>
        <button class="modal-close" onclick="closeModal()">
          <span class="icon" id="closeModalIcon"></span>
        </button>
      </div>
      <div class="modal-body">
        <!-- View Only Banner -->
        <div class="view-only-banner" id="viewOnlyBanner" style="display:none;">
          <span class="icon" id="bannerIcon"></span>
          <span id="bannerText">This job is assigned to another technician.</span>
        </div>

        <!-- Vehicle Info -->
        <div class="modal-section">
          <h4>Vehicle Information</h4>
          <div class="info-row">
            <span class="info-label">Shop</span>
            <span class="info-value" id="modalShop">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Vehicle</span>
            <span class="info-value" id="modalVehicle">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">VIN</span>
            <span class="info-value mono" id="modalVin">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Scheduled</span>
            <span class="info-value" id="modalSchedule">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Status</span>
            <span class="info-value" id="modalStatus">-</span>
          </div>
        </div>

        <!-- Calibrations -->
        <div class="modal-section">
          <h4>Required Calibrations</h4>
          <div class="calibrations-box" id="modalCalibrations">-</div>
        </div>

        <!-- Documents -->
        <div class="modal-section">
          <h4>Documents</h4>
          <div class="doc-grid" id="modalDocuments">
            <!-- Populated by JS -->
          </div>
        </div>

        <!-- Actions (hidden for view-only) -->
        <div class="modal-section" id="actionsSection">
          <h4>Actions</h4>
          <div class="action-buttons">
            <button class="btn btn-start" id="btnStart" onclick="updateStatus('In Progress')">
              <span class="icon" id="startIcon"></span>
              Start Job
            </button>
            <button class="btn btn-complete" id="btnComplete" onclick="updateStatus('Completed')">
              <span class="icon" id="completeIcon"></span>
              Complete
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/icons.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/api.js"></script>
  <script>
    // State
    let allJobs = [];
    let myJobs = [];
    let otherJobs = [];
    let currentJob = null;
    let currentTechName = '';
    let isAllJobsExpanded = false;

    // Helper functions
    function getStorageItem(key) {
      return localStorage.getItem(key) || sessionStorage.getItem(key);
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      // Check auth
      const token = getStorageItem('adas_access_token') || getStorageItem('token');
      const role = getStorageItem('adas_user_role') || getStorageItem('userRole');

      if (!token) {
        window.location.replace('/?logout=true');
        return;
      }

      if (role !== 'tech') {
        localStorage.clear();
        sessionStorage.clear();
        window.location.replace('/?logout=true');
        return;
      }

      // Get tech name
      currentTechName = getStorageItem('userName') || 'Technician';
      document.getElementById('techName').textContent = `Welcome, ${currentTechName}`;

      // Initialize icons
      initIcons();

      // Setup logout
      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.clear();
        sessionStorage.clear();
        window.location.replace('/?logout=true');
      });

      // Load jobs
      await loadJobs();
    });

    function initIcons() {
      document.getElementById('logoutIcon').innerHTML = Icons.logout;
      document.getElementById('closeModalIcon').innerHTML = Icons.x;
      document.getElementById('allJobsToggle').innerHTML = Icons.chevronRight;
      document.getElementById('viewOnlyIcon').innerHTML = Icons.eye;
      document.getElementById('bannerIcon').innerHTML = Icons.eye;
      document.getElementById('startIcon').innerHTML = Icons.wrench;
      document.getElementById('completeIcon').innerHTML = Icons.checkCircle;
    }

    async function loadJobs() {
      try {
        const token = getStorageItem('adas_access_token') || getStorageItem('token');
        const response = await fetch('/api/tech/vehicles', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        allJobs = data.vehicles || [];

        // Split into my jobs vs other jobs
        const techNameLower = currentTechName.toLowerCase().trim();
        myJobs = allJobs.filter(j => {
          const jobTech = (j.technician || j.technicianAssigned || '').toLowerCase().trim();
          return jobTech === techNameLower;
        });
        otherJobs = allJobs.filter(j => {
          const jobTech = (j.technician || j.technicianAssigned || '').toLowerCase().trim();
          return jobTech !== techNameLower;
        });

        renderYourJobs();
        renderAllJobs();

      } catch (err) {
        console.error('Load error:', err);
        document.getElementById('needsRevvList').innerHTML = '<div class="empty-state"><p>Failed to load jobs</p></div>';
      }
    }

    function renderYourJobs() {
      const today = new Date().toDateString();

      // Filter into categories
      const needsRevv = myJobs.filter(j => {
        const status = (j.status || '').toLowerCase();
        const hasRevv = j.revvReportUrl || j.revvPdf || j.revv_pdf || j.revvReportPdf;
        return !hasRevv && status !== 'completed' && status !== 'cancelled';
      });

      const todayJobs = myJobs.filter(j => {
        if (!j.scheduledDate) return false;
        const jobDate = new Date(j.scheduledDate).toDateString();
        const status = (j.status || '').toLowerCase();
        return jobDate === today && status !== 'completed';
      });

      const inProgress = myJobs.filter(j => {
        const status = (j.status || '').toLowerCase();
        return status === 'in progress';
      });

      // Update counts
      document.getElementById('yourJobsCount').textContent = myJobs.length;

      // Render Needs RevvADAS
      if (needsRevv.length === 0) {
        document.getElementById('needsRevvSection').style.display = 'none';
      } else {
        document.getElementById('needsRevvSection').style.display = 'block';
        document.getElementById('needsRevvList').innerHTML = needsRevv.map(j => renderJobRow(j, 'needs-action', 'red')).join('');
      }

      // Render Today
      if (todayJobs.length === 0) {
        document.getElementById('todayList').innerHTML = `
          <div class="empty-state">
            <span class="icon">${Icons.calendar}</span>
            <p>No jobs scheduled for today</p>
          </div>
        `;
      } else {
        document.getElementById('todayList').innerHTML = todayJobs.map(j => {
          const status = (j.status || '').toLowerCase();
          const colorClass = status === 'in progress' ? 'in-progress' : 'scheduled';
          const dotColor = status === 'in progress' ? 'purple' : 'blue';
          return renderJobRow(j, colorClass, dotColor);
        }).join('');
      }

      // Render In Progress
      if (inProgress.length === 0) {
        document.getElementById('inProgressSection').style.display = 'none';
      } else {
        document.getElementById('inProgressSection').style.display = 'block';
        document.getElementById('inProgressList').innerHTML = inProgress.map(j => renderJobRow(j, 'in-progress', 'purple')).join('');
      }
    }

    function renderAllJobs() {
      document.getElementById('allJobsCount').textContent = otherJobs.length;

      if (otherJobs.length === 0) {
        document.getElementById('allJobsList').innerHTML = `
          <div class="empty-state">
            <span class="icon">${Icons.checkCircle}</span>
            <p>No other jobs available</p>
          </div>
        `;
      } else {
        document.getElementById('allJobsList').innerHTML = otherJobs.map(j => renderJobRow(j, 'view-only', 'gray', true)).join('');
      }
    }

    function renderJobRow(job, statusClass, dotColor, viewOnly = false) {
      const roPo = escapeHtml(job.roPo || '');
      const shop = escapeHtml(job.shopName || 'Unknown Shop');
      const vehicle = escapeHtml(job.vehicle || 'Unknown Vehicle');
      const time = job.scheduledTime || '';
      const status = job.status || 'New';

      let badgeClass = 'scheduled';
      let badgeText = status;
      if (statusClass === 'needs-action') {
        badgeClass = 'needs-revv';
        badgeText = 'Needs Revv';
      } else if (statusClass === 'in-progress') {
        badgeClass = 'in-progress';
        badgeText = 'In Progress';
      } else if (statusClass === 'completed') {
        badgeClass = 'completed';
        badgeText = 'Completed';
      } else if (viewOnly) {
        badgeClass = 'view-only';
        badgeText = job.technician || job.technicianAssigned || 'Unassigned';
      }

      return `
        <div class="job-row ${statusClass}" onclick="openModal('${roPo}', ${viewOnly})">
          <div class="job-status-indicator ${dotColor}"></div>
          <div class="job-info">
            <div class="job-ro">RO #${roPo}</div>
            <div class="job-details">${shop} - ${vehicle}</div>
          </div>
          <div class="job-meta">
            ${time ? `<span class="job-time">${escapeHtml(time)}</span>` : ''}
            <span class="job-badge ${badgeClass}">${escapeHtml(badgeText)}</span>
            <span class="job-arrow">${Icons.chevronRight}</span>
          </div>
        </div>
      `;
    }

    function toggleAllJobs() {
      const section = document.getElementById('allJobsSection');
      const toggle = document.getElementById('allJobsToggle');

      isAllJobsExpanded = !isAllJobsExpanded;

      if (isAllJobsExpanded) {
        section.classList.add('expanded');
        toggle.style.transform = 'rotate(90deg)';
      } else {
        section.classList.remove('expanded');
        toggle.style.transform = 'rotate(0deg)';
      }
    }

    function openModal(roPo, viewOnly) {
      currentJob = allJobs.find(j => j.roPo === roPo);
      if (!currentJob) return;

      document.getElementById('modalTitle').textContent = `RO #${currentJob.roPo}`;
      document.getElementById('modalShop').textContent = currentJob.shopName || '-';
      document.getElementById('modalVehicle').textContent = currentJob.vehicle || '-';
      document.getElementById('modalVin').textContent = currentJob.vin || '-';
      document.getElementById('modalStatus').textContent = currentJob.status || 'New';

      // Schedule
      let scheduleText = '-';
      if (currentJob.scheduledDate) {
        const date = new Date(currentJob.scheduledDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        scheduleText = currentJob.scheduledTime ? `${date} at ${currentJob.scheduledTime}` : date;
      }
      document.getElementById('modalSchedule').textContent = scheduleText;

      // Calibrations
      document.getElementById('modalCalibrations').textContent = currentJob.requiredCalibrations || 'Not determined yet';

      // Documents
      const docs = [
        { name: 'Estimate', url: currentJob.estimatePdf || currentJob.estimate_pdf || currentJob.estimatePdfUrl },
        { name: 'Pre-Scan', url: currentJob.prescanPdf || currentJob.preScanPdf || currentJob.preScanPdfUrl },
        { name: 'Revv Report', url: currentJob.revvPdf || currentJob.revvReportPdf || currentJob.revvReportUrl },
        { name: 'Post-Scan', url: currentJob.postscanPdf || currentJob.postScanPdf || currentJob.postScanPdfUrl },
        { name: 'Invoice', url: currentJob.invoicePdf || currentJob.invoice_pdf || currentJob.invoicePdfUrl }
      ];

      document.getElementById('modalDocuments').innerHTML = docs.map(doc => {
        const hasUrl = doc.url && doc.url.startsWith('http');
        return `
          <${hasUrl ? 'a href="' + doc.url + '" target="_blank"' : 'div'} class="doc-item ${hasUrl ? 'available' : ''}">
            <span class="icon">${Icons.file}</span>
            <span>${doc.name}</span>
          </${hasUrl ? 'a' : 'div'}>
        `;
      }).join('');

      // Show/hide actions based on view-only
      const actionsSection = document.getElementById('actionsSection');
      const viewOnlyBanner = document.getElementById('viewOnlyBanner');

      if (viewOnly) {
        actionsSection.style.display = 'none';
        viewOnlyBanner.style.display = 'flex';
        const tech = currentJob.technician || currentJob.technicianAssigned || 'another technician';
        document.getElementById('bannerText').textContent = `Assigned to ${tech} (view only)`;
      } else {
        actionsSection.style.display = 'block';
        viewOnlyBanner.style.display = 'none';

        // Update button states based on current status
        const status = (currentJob.status || '').toLowerCase();
        const btnStart = document.getElementById('btnStart');
        const btnComplete = document.getElementById('btnComplete');

        if (status === 'in progress') {
          btnStart.classList.add('btn-disabled');
          btnStart.disabled = true;
          btnComplete.classList.remove('btn-disabled');
          btnComplete.disabled = false;
        } else if (status === 'completed') {
          btnStart.classList.add('btn-disabled');
          btnStart.disabled = true;
          btnComplete.classList.add('btn-disabled');
          btnComplete.disabled = true;
        } else {
          btnStart.classList.remove('btn-disabled');
          btnStart.disabled = false;
          btnComplete.classList.remove('btn-disabled');
          btnComplete.disabled = false;
        }
      }

      document.getElementById('jobModal').classList.add('open');
    }

    function closeModal() {
      document.getElementById('jobModal').classList.remove('open');
      currentJob = null;
    }

    async function updateStatus(newStatus) {
      if (!currentJob) return;

      try {
        const token = getStorageItem('adas_access_token') || getStorageItem('token');
        const response = await fetch(`/api/tech/vehicles/${currentJob.roPo}/status`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: newStatus })
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        closeModal();
        await loadJobs();
      } catch (err) {
        alert('Failed to update status: ' + err.message);
      }
    }

    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    // Close on backdrop click
    document.getElementById('jobModal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) closeModal();
    });
  </script>
</body>
</html>
