<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - ADAS F1RST Tech Portal</title>
  <link rel="stylesheet" href="/css/apple-style.css">
  <link rel="stylesheet" href="/css/portal.css">
  <style>
    /* Simplified Tech Portal Styles */
    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .dashboard-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary, #1d1d1f);
    }

    .tech-name {
      font-size: 15px;
      color: var(--text-secondary, #86868b);
      margin-top: 4px;
    }

    /* Section Styles */
    .section {
      margin-bottom: 32px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      cursor: pointer;
    }

    .section-header h2 {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary, #1d1d1f);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-count {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary, #86868b);
      background: var(--bg-grouped, #f2f2f7);
      padding: 4px 12px;
      border-radius: 12px;
    }

    .section-toggle {
      width: 24px;
      height: 24px;
      color: var(--text-tertiary, #aeaeb2);
      transition: transform 0.2s ease;
    }

    .section.collapsed .section-toggle {
      transform: rotate(-90deg);
    }

    .section.collapsed .section-content {
      display: none;
    }

    /* Subsection Styles */
    .subsection {
      margin-bottom: 24px;
    }

    .subsection-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .subsection-header h3 {
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary, #86868b);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .status-dot.red { background: #ff3b30; }
    .status-dot.blue { background: #007aff; }
    .status-dot.purple { background: #af52de; }
    .status-dot.green { background: #34c759; }
    .status-dot.orange { background: #ff9500; }
    .status-dot.gray { background: #8e8e93; }

    /* Job Card Styles */
    .job-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .job-row {
      display: flex;
      align-items: center;
      padding: 16px;
      background: #fff;
      border: 1px solid var(--border-subtle, rgba(0, 0, 0, 0.06));
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .job-row:hover {
      background: var(--bg-grouped, #f2f2f7);
      border-color: var(--border, rgba(0, 0, 0, 0.1));
    }

    .job-row.needs-action {
      border-left: 3px solid #ff3b30;
    }

    .job-row.scheduled {
      border-left: 3px solid #007aff;
    }

    .job-row.in-progress {
      border-left: 3px solid #af52de;
    }

    .job-row.completed {
      border-left: 3px solid #34c759;
    }

    .job-row.view-only {
      opacity: 0.7;
      border-left: 3px solid #8e8e93;
    }

    .job-row.view-only:hover {
      opacity: 0.85;
    }

    .job-status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 16px;
      flex-shrink: 0;
    }

    .job-status-indicator.red { background: #ff3b30; }
    .job-status-indicator.blue { background: #007aff; }
    .job-status-indicator.purple { background: #af52de; }
    .job-status-indicator.green { background: #34c759; }
    .job-status-indicator.orange { background: #ff9500; }
    .job-status-indicator.gray { background: #8e8e93; }

    .job-info {
      flex: 1;
      min-width: 0;
    }

    .job-ro {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary, #1d1d1f);
      margin-bottom: 4px;
    }

    .job-details {
      font-size: 14px;
      color: var(--text-secondary, #86868b);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .job-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      margin-left: 16px;
    }

    .job-time {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary, #86868b);
    }

    .job-badge {
      font-size: 12px;
      font-weight: 500;
      padding: 4px 10px;
      border-radius: 6px;
    }

    .job-badge.needs-revv {
      background: rgba(255, 59, 48, 0.1);
      color: #ff3b30;
    }

    .job-badge.scheduled {
      background: rgba(0, 122, 255, 0.1);
      color: #007aff;
    }

    .job-badge.in-progress {
      background: rgba(175, 82, 222, 0.1);
      color: #af52de;
    }

    .job-badge.completed {
      background: rgba(52, 199, 89, 0.1);
      color: #34c759;
    }

    .job-badge.view-only {
      background: rgba(142, 142, 147, 0.1);
      color: #8e8e93;
    }

    .job-arrow {
      width: 16px;
      height: 16px;
      color: var(--text-tertiary, #aeaeb2);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: var(--text-secondary, #86868b);
    }

    .empty-state .icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 12px;
      color: var(--text-tertiary, #aeaeb2);
    }

    .empty-state p {
      font-size: 15px;
    }

    /* All Jobs Section (collapsible) */
    .all-jobs-section {
      background: var(--bg-grouped, #f2f2f7);
      border-radius: 16px;
      padding: 20px;
    }

    .all-jobs-section .section-header {
      margin-bottom: 0;
    }

    .all-jobs-section.expanded .section-header {
      margin-bottom: 16px;
    }

    .all-jobs-section .section-content {
      display: none;
    }

    .all-jobs-section.expanded .section-content {
      display: block;
    }

    .view-only-note {
      font-size: 13px;
      color: var(--text-tertiary, #aeaeb2);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Header Styles */
    .simple-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: #fff;
      border-bottom: 1px solid var(--border-subtle, rgba(0, 0, 0, 0.06));
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .last-refresh {
      font-size: 11px;
      color: var(--text-tertiary, #aeaeb2);
      margin-left: 8px;
      padding: 2px 8px;
      background: var(--bg-grouped, #f2f2f7);
      border-radius: 10px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 16px;
    }

    .logo-text {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary, #1d1d1f);
    }

    .btn-logout {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary, #86868b);
      background: var(--bg-grouped, #f2f2f7);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn-logout:hover {
      background: var(--bg, #e5e5ea);
      color: var(--text-primary, #1d1d1f);
    }

    .btn-logout .icon {
      width: 16px;
      height: 16px;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-subtle, rgba(0, 0, 0, 0.06));
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header h3 {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-grouped, #f2f2f7);
      border: none;
      border-radius: 50%;
      cursor: pointer;
    }

    .modal-close:hover {
      background: var(--bg, #e5e5ea);
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
    }

    .modal-section {
      margin-bottom: 24px;
    }

    .modal-section:last-child {
      margin-bottom: 0;
    }

    .modal-section h4 {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary, #86868b);
      margin-bottom: 12px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-subtle, rgba(0, 0, 0, 0.06));
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      font-size: 14px;
      color: var(--text-secondary, #86868b);
    }

    .info-value {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary, #1d1d1f);
    }

    .info-value.mono {
      font-family: ui-monospace, monospace;
      font-size: 13px;
    }

    .status-badge-inline {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
    }

    .status-badge-inline.new {
      background: rgba(255, 59, 48, 0.1);
      color: #ff3b30;
    }

    .status-badge-inline.ready {
      background: rgba(255, 149, 0, 0.1);
      color: #ff9500;
    }

    .status-badge-inline.scheduled {
      background: rgba(0, 122, 255, 0.1);
      color: #007aff;
    }

    .status-badge-inline.in-progress {
      background: rgba(175, 82, 222, 0.1);
      color: #af52de;
    }

    .status-badge-inline.completed {
      background: rgba(52, 199, 89, 0.1);
      color: #34c759;
    }

    .calibrations-box {
      background: var(--bg-grouped, #f2f2f7);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      color: var(--text-primary, #1d1d1f);
    }

    /* Document Grid */
    .doc-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .doc-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--bg-grouped, #f2f2f7);
      border-radius: 10px;
      font-size: 14px;
      color: var(--text-secondary, #86868b);
      text-decoration: none;
      transition: all 0.15s ease;
    }

    .doc-item.available {
      color: var(--text-primary, #1d1d1f);
      cursor: pointer;
      border: 1px solid transparent;
    }

    .doc-item.available:hover {
      background: #e5e5ea;
      border-color: var(--border, rgba(0, 0, 0, 0.1));
    }

    .doc-item .icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .doc-item.available .icon {
      color: #007aff;
    }

    .doc-item .doc-name {
      flex: 1;
    }

    .doc-item .doc-status {
      font-size: 12px;
      color: var(--text-tertiary, #aeaeb2);
    }

    .doc-item.available .doc-status {
      color: #34c759;
    }

    /* Status-specific sections */
    .waiting-message {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: rgba(255, 149, 0, 0.1);
      border-radius: 10px;
      color: #ff9500;
      font-size: 14px;
    }

    .waiting-message .icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    /* File Upload Zone */
    .upload-zone {
      border: 2px dashed var(--border, rgba(0, 0, 0, 0.15));
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s ease;
      background: var(--bg-grouped, #f2f2f7);
    }

    .upload-zone:hover {
      border-color: #007aff;
      background: rgba(0, 122, 255, 0.05);
    }

    .upload-zone.dragover {
      border-color: #007aff;
      background: rgba(0, 122, 255, 0.1);
    }

    .upload-zone .icon {
      width: 32px;
      height: 32px;
      color: #007aff;
      margin-bottom: 8px;
    }

    .upload-zone p {
      font-size: 14px;
      color: var(--text-secondary, #86868b);
      margin: 0;
    }

    .upload-zone .filename {
      font-weight: 500;
      color: var(--text-primary, #1d1d1f);
      margin-top: 8px;
    }

    .upload-zone input[type="file"] {
      display: none;
    }

    /* Calibration Checkboxes */
    .calibration-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .calibration-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-grouped, #f2f2f7);
      border-radius: 10px;
      transition: all 0.15s ease;
    }

    .calibration-item:hover {
      background: #e5e5ea;
    }

    .calibration-item.selected {
      background: rgba(0, 122, 255, 0.1);
      border: 1px solid rgba(0, 122, 255, 0.3);
    }

    .calibration-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin: 0;
      flex-shrink: 0;
      accent-color: #007aff;
    }

    .calibration-item .cal-content {
      flex: 1;
    }

    .calibration-item .cal-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary, #1d1d1f);
      margin-bottom: 4px;
    }

    .calibration-item .cal-options {
      display: flex;
      gap: 16px;
      margin-top: 8px;
    }

    .calibration-item .cal-option {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--text-secondary, #86868b);
    }

    .calibration-item .cal-option input[type="radio"] {
      width: 16px;
      height: 16px;
      margin: 0;
      accent-color: #007aff;
    }

    .calibration-item .cal-fixed {
      font-size: 12px;
      color: var(--text-tertiary, #aeaeb2);
    }

    .no-cal-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: rgba(255, 149, 0, 0.1);
      border-radius: 10px;
      margin-top: 12px;
    }

    .no-cal-option input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin: 0;
      accent-color: #ff9500;
    }

    .no-cal-option .no-cal-content {
      flex: 1;
    }

    .no-cal-option .no-cal-label {
      font-size: 14px;
      font-weight: 500;
      color: #ff9500;
    }

    .no-cal-option .no-cal-hint {
      font-size: 12px;
      color: var(--text-secondary, #86868b);
      margin-top: 4px;
    }

    .other-calibration {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-grouped, #f2f2f7);
      border-radius: 10px;
    }

    .other-calibration input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin: 0;
      flex-shrink: 0;
    }

    .other-calibration input[type="text"] {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--border, rgba(0, 0, 0, 0.1));
      border-radius: 6px;
      font-size: 14px;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 12px;
    }

    .action-buttons .btn {
      flex: 1;
      padding: 14px 20px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.15s ease;
    }

    .action-buttons .btn .icon {
      width: 18px;
      height: 18px;
    }

    .btn-primary {
      background: #007aff;
      color: white;
    }

    .btn-primary:hover {
      background: #0066d6;
    }

    .btn-start {
      background: #af52de;
      color: white;
    }

    .btn-start:hover {
      background: #9b47c7;
    }

    .btn-complete {
      background: #34c759;
      color: white;
    }

    .btn-complete:hover {
      background: #2db84d;
    }

    .btn-disabled {
      background: var(--bg-grouped, #f2f2f7) !important;
      color: var(--text-tertiary, #aeaeb2) !important;
      cursor: not-allowed !important;
    }

    .view-only-banner {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: rgba(142, 142, 147, 0.1);
      border-radius: 8px;
      font-size: 14px;
      color: #8e8e93;
      margin-bottom: 16px;
    }

    .view-only-banner .icon {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    /* Completion Info */
    .completion-info {
      background: rgba(52, 199, 89, 0.1);
      border-radius: 10px;
      padding: 16px;
    }

    .completion-info .info-row {
      border-color: rgba(52, 199, 89, 0.2);
    }

    .completion-info .info-value {
      color: #34c759;
    }

    /* Loading */
    .loading {
      display: flex;
      justify-content: center;
      padding: 32px;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top-color: var(--primary, #007aff);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 300;
      flex-direction: column;
      gap: 16px;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-overlay .spinner-large {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border, rgba(0, 0, 0, 0.1));
      border-top-color: #007aff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-overlay .loading-text {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-secondary, #86868b);
    }

    /* Toast Notification */
    .toast-container {
      position: fixed;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 400;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      pointer-events: none;
    }

    .toast {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 20px;
      background: #1d1d1f;
      color: white;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s ease;
      pointer-events: auto;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.success {
      background: #34c759;
    }

    .toast.error {
      background: #ff3b30;
    }

    .toast.info {
      background: #007aff;
    }

    .toast .icon {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    /* ============================================
       ACTIVE JOB BANNER STYLES
       ============================================ */

    .active-job-banner {
      background: linear-gradient(135deg, #af52de 0%, #8b5cf6 100%);
      color: white;
      padding: 16px 24px;
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      box-shadow: 0 4px 12px rgba(175, 82, 222, 0.3);
    }

    .active-job-banner.visible {
      display: flex;
    }

    .active-job-info {
      display: flex;
      align-items: center;
      gap: 20px;
      flex: 1;
      min-width: 0;
    }

    .active-job-icon {
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .active-job-icon .icon {
      width: 24px;
      height: 24px;
    }

    .active-job-details {
      flex: 1;
      min-width: 0;
    }

    .active-job-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .active-job-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .active-job-subtitle {
      font-size: 13px;
      opacity: 0.9;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .active-job-timer {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 20px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      flex-shrink: 0;
    }

    .timer-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .timer-value {
      font-size: 28px;
      font-weight: 700;
      font-family: ui-monospace, 'SF Mono', monospace;
      letter-spacing: 1px;
    }

    .active-job-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .btn-complete-banner {
      padding: 12px 20px;
      background: white;
      color: #af52de;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-complete-banner:hover {
      background: #f0f0f0;
      transform: scale(1.02);
    }

    .btn-complete-banner .icon {
      width: 16px;
      height: 16px;
    }

    /* Complete Job Modal */
    .complete-modal-content {
      padding: 24px;
    }

    .complete-calibrations {
      margin-bottom: 20px;
    }

    .complete-calibrations label {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: var(--bg-grouped, #f2f2f7);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .complete-calibrations label:hover {
      background: #e5e5ea;
    }

    .complete-calibrations label.selected {
      background: rgba(52, 199, 89, 0.1);
      border: 1px solid rgba(52, 199, 89, 0.3);
    }

    .complete-calibrations input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #34c759;
    }

    .complete-notes textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border, rgba(0, 0, 0, 0.1));
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }

    .complete-notes textarea:focus {
      outline: none;
      border-color: #007aff;
    }

    /* Disabled Start Job Button */
    .btn-start.disabled-job {
      background: var(--bg-grouped, #f2f2f7) !important;
      color: var(--text-tertiary, #aeaeb2) !important;
      cursor: not-allowed !important;
    }

    .start-blocked-message {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: rgba(255, 149, 0, 0.1);
      border-radius: 8px;
      color: #ff9500;
      font-size: 14px;
      margin-bottom: 16px;
    }

    .start-blocked-message .icon {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .dashboard-container {
        padding: 16px;
      }

      .dashboard-title {
        font-size: 24px;
      }

      .job-row {
        padding: 12px;
      }

      .job-meta {
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
      }

      .doc-grid {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }

      .active-job-banner {
        flex-direction: column;
        align-items: stretch;
        padding: 16px;
      }

      .active-job-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .active-job-timer {
        flex-direction: row;
        justify-content: space-between;
        padding: 12px 16px;
      }

      .timer-value {
        font-size: 24px;
      }

      .active-job-actions {
        width: 100%;
      }

      .btn-complete-banner {
        flex: 1;
        justify-content: center;
      }
    }

    /* ============================================
       WEEKLY CALENDAR STYLES
       ============================================ */

    .calendar-section {
      margin-bottom: 32px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding: 0 4px;
    }

    .calendar-header h2 {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary, #1d1d1f);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .calendar-nav button {
      padding: 8px 12px;
      border: 1px solid var(--border, rgba(0, 0, 0, 0.1));
      border-radius: 8px;
      background: #fff;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary, #86868b);
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .calendar-nav button:hover {
      background: var(--bg-grouped, #f2f2f7);
      color: var(--text-primary, #1d1d1f);
    }

    .calendar-nav button.today-btn {
      background: #007aff;
      color: white;
      border-color: #007aff;
    }

    .calendar-nav button.today-btn:hover {
      background: #0066d6;
    }

    .calendar-nav .week-range {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary, #1d1d1f);
      min-width: 180px;
      text-align: center;
    }

    /* Calendar Grid */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      background: var(--bg-grouped, #f2f2f7);
      padding: 12px;
      border-radius: 16px;
    }

    .calendar-day {
      background: #fff;
      border-radius: 12px;
      min-height: 180px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid transparent;
      transition: all 0.15s ease;
    }

    .calendar-day.today {
      border-color: #007aff;
      box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.15);
    }

    .calendar-day.has-jobs {
      border-color: var(--border, rgba(0, 0, 0, 0.08));
    }

    .day-header {
      padding: 10px 12px;
      background: var(--bg-grouped, #f2f2f7);
      border-bottom: 1px solid var(--border-subtle, rgba(0, 0, 0, 0.06));
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .calendar-day.today .day-header {
      background: rgba(0, 122, 255, 0.1);
    }

    .day-name {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary, #86868b);
    }

    .calendar-day.today .day-name {
      color: #007aff;
    }

    .day-date {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary, #1d1d1f);
    }

    .calendar-day.today .day-date {
      color: #007aff;
    }

    .day-count {
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
      background: var(--bg, #e5e5ea);
      color: var(--text-secondary, #86868b);
    }

    .calendar-day.today .day-count {
      background: #007aff;
      color: white;
    }

    .day-jobs {
      flex: 1;
      padding: 8px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    /* Capacity Indicator */
    .capacity-bar {
      height: 3px;
      background: var(--bg, #e5e5ea);
      border-radius: 2px;
      margin: 0 12px 8px;
      overflow: hidden;
    }

    .capacity-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .capacity-fill.low { background: #34c759; }
    .capacity-fill.medium { background: #ff9500; }
    .capacity-fill.high { background: #ff3b30; }

    /* Calendar Job Card */
    .cal-job-card {
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
      border-left: 3px solid;
    }

    .cal-job-card:hover {
      transform: translateX(2px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .cal-job-card.status-new,
    .cal-job-card.status-ready {
      background: rgba(255, 149, 0, 0.1);
      border-color: #ff9500;
    }

    .cal-job-card.status-scheduled,
    .cal-job-card.status-rescheduled {
      background: rgba(0, 122, 255, 0.1);
      border-color: #007aff;
    }

    .cal-job-card.status-in-progress {
      background: rgba(175, 82, 222, 0.1);
      border-color: #af52de;
    }

    .cal-job-card.status-completed {
      background: rgba(52, 199, 89, 0.1);
      border-color: #34c759;
    }

    .cal-job-card.status-cancelled {
      background: rgba(142, 142, 147, 0.1);
      border-color: #8e8e93;
      opacity: 0.6;
    }

    .cal-job-ro {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary, #1d1d1f);
      margin-bottom: 2px;
    }

    .cal-job-vehicle {
      font-size: 11px;
      color: var(--text-secondary, #86868b);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .cal-job-shop {
      font-size: 10px;
      color: var(--text-tertiary, #aeaeb2);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .cal-job-time {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-secondary, #86868b);
      margin-top: 4px;
    }

    /* Empty day state */
    .day-empty {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-tertiary, #aeaeb2);
      font-size: 12px;
    }

    /* Calendar responsive */
    @media (max-width: 900px) {
      .calendar-grid {
        grid-template-columns: repeat(4, 1fr);
      }

      .calendar-day:nth-child(n+5) {
        display: none;
      }
    }

    @media (max-width: 640px) {
      .calendar-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .calendar-day {
        min-height: auto;
      }

      .calendar-day:nth-child(n+5) {
        display: flex;
      }

      .day-jobs {
        max-height: 200px;
      }

      .calendar-nav {
        flex-wrap: wrap;
        justify-content: center;
      }

      .calendar-header {
        flex-direction: column;
        gap: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-large"></div>
    <span class="loading-text" id="loadingText">Processing...</span>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Simple Header -->
  <header class="simple-header">
    <div class="header-logo">
      <div class="logo-icon">A</div>
      <span class="logo-text">ADAS F1RST</span>
    </div>
    <button class="btn-logout" id="logoutBtn">
      <span class="icon" id="logoutIcon"></span>
      Sign Out
    </button>
  </header>

  <!-- Active Job Banner -->
  <div class="active-job-banner" id="activeJobBanner">
    <div class="active-job-info">
      <div class="active-job-icon">
        <span class="icon" id="activeJobIcon"></span>
      </div>
      <div class="active-job-details">
        <div class="active-job-label">Active Job</div>
        <div class="active-job-title" id="activeJobTitle">RO #---</div>
        <div class="active-job-subtitle" id="activeJobSubtitle">Loading...</div>
      </div>
    </div>
    <div class="active-job-timer">
      <div class="timer-label">Elapsed</div>
      <div class="timer-value" id="activeJobTimer">00:00:00</div>
    </div>
    <div class="active-job-actions">
      <button class="btn-complete-banner" onclick="openCompleteJobModal()">
        <span class="icon" id="completeBannerIcon"></span>
        Complete Job
      </button>
    </div>
  </div>

  <div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <div>
        <h1 class="dashboard-title">Your Dashboard</h1>
        <p class="tech-name" id="techName">Loading...</p>
      </div>
    </div>

    <!-- WEEKLY CALENDAR Section -->
    <div class="calendar-section" id="calendarSection">
      <div class="calendar-header">
        <h2>
          <span class="status-dot blue"></span>
          Weekly Schedule
        </h2>
        <div class="calendar-nav">
          <button onclick="navigateWeek(-1)" title="Previous Week">
            <span id="prevWeekIcon"></span>
            Prev
          </button>
          <button class="today-btn" onclick="navigateWeek(0)" title="Go to Today">
            Today
          </button>
          <span class="week-range" id="weekRange">Loading...</span>
          <button onclick="navigateWeek(1)" title="Next Week">
            Next
            <span id="nextWeekIcon"></span>
          </button>
        </div>
      </div>

      <div class="calendar-grid" id="calendarGrid">
        <!-- Calendar days will be rendered by JavaScript -->
        <div class="loading" style="grid-column: 1 / -1;"><div class="spinner"></div></div>
      </div>
    </div>

    <!-- YOUR JOBS Section -->
    <div class="section" id="yourJobsSection">
      <div class="section-header">
        <h2>
          <span class="status-dot blue"></span>
          Your Jobs
        </h2>
        <span class="section-count" id="yourJobsCount">0</span>
      </div>

      <div class="section-content" id="yourJobsContent">
        <!-- Needs RevvADAS -->
        <div class="subsection" id="needsRevvSection">
          <div class="subsection-header">
            <span class="status-dot red"></span>
            <h3>Needs RevvADAS Report</h3>
          </div>
          <div class="job-list" id="needsRevvList">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </div>

        <!-- Today's Schedule -->
        <div class="subsection" id="todaySection">
          <div class="subsection-header">
            <span class="status-dot blue"></span>
            <h3>Today's Schedule</h3>
          </div>
          <div class="job-list" id="todayList">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </div>

        <!-- In Progress -->
        <div class="subsection" id="inProgressSection">
          <div class="subsection-header">
            <span class="status-dot purple"></span>
            <h3>In Progress</h3>
          </div>
          <div class="job-list" id="inProgressList">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ALL JOBS Section (Collapsed by default) -->
    <div class="section all-jobs-section" id="allJobsSection">
      <div class="section-header" onclick="toggleAllJobs()">
        <h2>
          <span class="status-dot gray"></span>
          All Jobs
        </h2>
        <div style="display:flex;align-items:center;gap:12px;">
          <span class="section-count" id="allJobsCount">0</span>
          <span class="section-toggle" id="allJobsToggle"></span>
        </div>
      </div>
      <div class="section-content" id="allJobsContent">
        <p class="view-only-note">
          <span class="icon" id="viewOnlyIcon"></span>
          Jobs assigned to other technicians (view only)
        </p>
        <div class="job-list" id="allJobsList">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Job Detail Modal -->
  <div class="modal-overlay" id="jobModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle">RO #---</h3>
        <button class="modal-close" onclick="closeModal()">
          <span class="icon" id="closeModalIcon"></span>
        </button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Content populated dynamically by JS based on status -->
      </div>
    </div>
  </div>

  <!-- Complete Job Modal -->
  <div class="modal-overlay" id="completeJobModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Complete Job - <span id="completeJobRO">RO #---</span></h3>
        <button class="modal-close" onclick="closeCompleteJobModal()">
          <span class="icon" id="closeCompleteIcon"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="complete-modal-content">
          <div class="modal-section">
            <h4>Calibrations Completed</h4>
            <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;">Select all calibrations that were performed:</p>
            <div class="complete-calibrations" id="completeCalibrationsContainer">
              <!-- Populated dynamically from required calibrations -->
            </div>
          </div>

          <div class="modal-section">
            <h4>Notes (Optional)</h4>
            <div class="complete-notes">
              <textarea id="completeJobNotes" placeholder="Add any notes about the job completion..."></textarea>
            </div>
          </div>

          <div class="modal-section">
            <div class="action-buttons">
              <button class="btn btn-complete" onclick="submitJobCompletion()">
                <span class="icon" id="submitCompleteIcon"></span>
                Complete Job
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/icons.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/api.js"></script>
  <script>
    // State
    let allJobs = [];
    let myJobs = [];
    let otherJobs = [];
    let currentJob = null;
    let currentTechName = '';
    let isAllJobsExpanded = false;
    let selectedCalibrations = {};
    let uploadedRevvFile = null;
    let uploadedInvoiceFile = null;
    let uploadedPostScanFile = null;

    // Active job state
    let activeJobData = null;
    let activeJobTimerInterval = null;
    const ACTIVE_JOB_STORAGE_KEY = 'adas_active_job';

    // Calendar state
    let currentWeekStart = getMonday(new Date());
    const MAX_JOBS_PER_DAY = 3; // Capacity limit

    // Get Monday of the week for a given date
    function getMonday(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      d.setDate(diff);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    // Navigate week
    function navigateWeek(direction) {
      if (direction === 0) {
        // Go to today
        currentWeekStart = getMonday(new Date());
      } else {
        currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
      }
      renderCalendar();
    }

    // Format date range for header
    function formatWeekRange(startDate) {
      const endDate = new Date(startDate);
      endDate.setDate(endDate.getDate() + 6);

      const startMonth = startDate.toLocaleDateString('en-US', { month: 'short' });
      const endMonth = endDate.toLocaleDateString('en-US', { month: 'short' });
      const startDay = startDate.getDate();
      const endDay = endDate.getDate();

      if (startMonth === endMonth) {
        return `${startMonth} ${startDay} - ${endDay}`;
      } else {
        return `${startMonth} ${startDay} - ${endMonth} ${endDay}`;
      }
    }

    // Get jobs for a specific date
    function getJobsForDate(date) {
      const dateStr = date.toISOString().split('T')[0];
      return myJobs.filter(job => {
        if (!job.scheduledDate) return false;
        const jobDate = new Date(job.scheduledDate).toISOString().split('T')[0];
        return jobDate === dateStr;
      });
    }

    // Get status class for job card
    function getStatusClass(status) {
      const s = (status || '').toLowerCase();
      if (s === 'new') return 'status-new';
      if (s === 'ready' || s === 'ready to schedule') return 'status-ready';
      if (s === 'scheduled' || s === 'rescheduled') return 'status-scheduled';
      if (s === 'in progress') return 'status-in-progress';
      if (s === 'completed') return 'status-completed';
      if (s === 'cancelled') return 'status-cancelled';
      return 'status-scheduled';
    }

    // Render the calendar
    function renderCalendar() {
      const grid = document.getElementById('calendarGrid');
      const weekRange = document.getElementById('weekRange');

      if (!grid) return;

      // Update week range header
      weekRange.textContent = formatWeekRange(currentWeekStart);

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayStr = today.toISOString().split('T')[0];

      const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      let html = '';

      for (let i = 0; i < 7; i++) {
        const date = new Date(currentWeekStart);
        date.setDate(date.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        const isToday = dateStr === todayStr;
        const dayJobs = getJobsForDate(date);
        const jobCount = dayJobs.length;
        const capacityPercent = Math.min((jobCount / MAX_JOBS_PER_DAY) * 100, 100);
        const capacityClass = capacityPercent <= 33 ? 'low' : capacityPercent <= 66 ? 'medium' : 'high';

        html += `
          <div class="calendar-day ${isToday ? 'today' : ''} ${jobCount > 0 ? 'has-jobs' : ''}">
            <div class="day-header">
              <div>
                <div class="day-name">${dayNames[i]}</div>
                <div class="day-date">${date.getDate()}</div>
              </div>
              ${jobCount > 0 ? `<span class="day-count">${jobCount}</span>` : ''}
            </div>
            ${jobCount > 0 ? `
              <div class="capacity-bar">
                <div class="capacity-fill ${capacityClass}" style="width: ${capacityPercent}%"></div>
              </div>
            ` : ''}
            <div class="day-jobs">
              ${jobCount > 0 ? dayJobs.map(job => renderCalendarJobCard(job)).join('') : `
                <div class="day-empty">No jobs</div>
              `}
            </div>
          </div>
        `;
      }

      grid.innerHTML = html;
    }

    // Render a job card for the calendar
    function renderCalendarJobCard(job) {
      const statusClass = getStatusClass(job.status);
      const ro = escapeHtml(job.roPo || '');
      const vehicle = escapeHtml(job.vehicle || 'Unknown');
      const shop = escapeHtml(job.shopName || '');
      const time = job.scheduledTime || '';

      return `
        <div class="cal-job-card ${statusClass}" onclick="openModal('${ro}', false)">
          <div class="cal-job-ro">RO #${ro}</div>
          <div class="cal-job-vehicle">${vehicle}</div>
          ${shop ? `<div class="cal-job-shop">${shop}</div>` : ''}
          ${time ? `<div class="cal-job-time">${escapeHtml(time)}</div>` : ''}
        </div>
      `;
    }

    // ============================================
    // ACTIVE JOB FUNCTIONS
    // ============================================

    // Check for active job on load and from server
    async function checkActiveJob() {
      try {
        const token = getStorageItem('adas_access_token') || getStorageItem('token');
        const response = await fetch('/api/tech/active-job', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();

        if (data.success && data.activeJob) {
          // Get start time from localStorage or use now
          const stored = JSON.parse(localStorage.getItem(ACTIVE_JOB_STORAGE_KEY) || '{}');
          const startTime = stored.roPo === data.activeJob.roPo ? stored.startTime : new Date().toISOString();

          // Store/update in localStorage
          localStorage.setItem(ACTIVE_JOB_STORAGE_KEY, JSON.stringify({
            ...data.activeJob,
            startTime: startTime
          }));

          activeJobData = { ...data.activeJob, startTime };
          showActiveJobBanner();
        } else {
          // No active job on server, clear local storage
          localStorage.removeItem(ACTIVE_JOB_STORAGE_KEY);
          activeJobData = null;
          hideActiveJobBanner();
        }
      } catch (err) {
        console.error('Error checking active job:', err);
        // Fallback to localStorage
        const stored = localStorage.getItem(ACTIVE_JOB_STORAGE_KEY);
        if (stored) {
          activeJobData = JSON.parse(stored);
          showActiveJobBanner();
        }
      }
    }

    // Show active job banner with timer
    function showActiveJobBanner() {
      if (!activeJobData) return;

      const banner = document.getElementById('activeJobBanner');
      const title = document.getElementById('activeJobTitle');
      const subtitle = document.getElementById('activeJobSubtitle');

      title.textContent = `RO #${activeJobData.roPo}`;
      subtitle.textContent = `${activeJobData.vehicle || 'Vehicle'} â€¢ ${activeJobData.shopName || 'Shop'}`;

      banner.classList.add('visible');
      startTimer();
    }

    // Hide active job banner
    function hideActiveJobBanner() {
      const banner = document.getElementById('activeJobBanner');
      banner.classList.remove('visible');
      stopTimer();
    }

    // Start elapsed time timer
    function startTimer() {
      if (activeJobTimerInterval) clearInterval(activeJobTimerInterval);

      updateTimerDisplay();
      activeJobTimerInterval = setInterval(updateTimerDisplay, 1000);
    }

    // Stop timer
    function stopTimer() {
      if (activeJobTimerInterval) {
        clearInterval(activeJobTimerInterval);
        activeJobTimerInterval = null;
      }
    }

    // Update timer display
    function updateTimerDisplay() {
      if (!activeJobData || !activeJobData.startTime) return;

      const start = new Date(activeJobData.startTime);
      const now = new Date();
      const elapsed = Math.floor((now - start) / 1000); // seconds

      const hours = Math.floor(elapsed / 3600);
      const minutes = Math.floor((elapsed % 3600) / 60);
      const seconds = elapsed % 60;

      const display = [
        hours.toString().padStart(2, '0'),
        minutes.toString().padStart(2, '0'),
        seconds.toString().padStart(2, '0')
      ].join(':');

      const timerEl = document.getElementById('activeJobTimer');
      if (timerEl) timerEl.textContent = display;
    }

    // Start a job
    async function startJobAction(roPo) {
      console.log('[START_JOB] ====== Start Job clicked ======');
      console.log('[START_JOB] RO:', roPo);

      // Check if already have an active job
      if (activeJobData && activeJobData.roPo !== roPo) {
        console.log('[START_JOB] Blocked - already has active job:', activeJobData.roPo);
        showToast('Complete your current job first', 'error');
        return;
      }

      try {
        showLoading('Starting job...');

        const token = getStorageItem('adas_access_token') || getStorageItem('token');
        console.log('[START_JOB] Calling API /api/tech/start-job...');

        const response = await fetch('/api/tech/start-job', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ roPo })
        });

        const data = await response.json();
        console.log('[START_JOB] API response:', JSON.stringify(data));
        hideLoading();

        if (!data.success) {
          console.error('[START_JOB] API returned error:', data.error);
          if (data.activeJob) {
            showToast(`Complete RO #${data.activeJob.roPo} first`, 'error');
          } else {
            showToast(data.error || 'Failed to start job', 'error');
          }
          return;
        }

        console.log('[START_JOB] SUCCESS - Sheets updated, status is now "In Progress"');

        // Store active job
        const jobInfo = {
          roPo: roPo,
          vehicle: data.job?.vehicle || currentJob?.vehicle,
          shopName: data.job?.shopName || currentJob?.shopName,
          requiredCalibrations: data.job?.requiredCalibrations || currentJob?.requiredCalibrations,
          startTime: data.startTime
        };

        localStorage.setItem(ACTIVE_JOB_STORAGE_KEY, JSON.stringify(jobInfo));
        activeJobData = jobInfo;
        console.log('[START_JOB] Stored active job in localStorage:', JSON.stringify(jobInfo));

        showActiveJobBanner();
        closeModal();
        await loadJobs();
        showToast('Job started!', 'success');

      } catch (err) {
        console.error('[START_JOB] Exception:', err);
        hideLoading();
        showToast('Failed to start job: ' + err.message, 'error');
      }
    }

    // Open complete job modal
    function openCompleteJobModal() {
      if (!activeJobData) return;

      document.getElementById('completeJobRO').textContent = `RO #${activeJobData.roPo}`;

      // Populate calibrations from required calibrations
      const container = document.getElementById('completeCalibrationsContainer');
      const calibrations = (activeJobData.requiredCalibrations || '').split(',').map(c => c.trim()).filter(c => c);

      if (calibrations.length === 0) {
        container.innerHTML = '<p style="color:var(--text-secondary);font-size:14px;">No specific calibrations recorded</p>';
      } else {
        container.innerHTML = calibrations.map((cal, i) => `
          <label>
            <input type="checkbox" name="completed_cal" value="${escapeHtml(cal)}" checked>
            <span>${escapeHtml(cal)}</span>
          </label>
        `).join('');
      }

      // Clear notes
      document.getElementById('completeJobNotes').value = '';

      document.getElementById('completeJobModal').classList.add('open');
    }

    // Close complete job modal
    function closeCompleteJobModal() {
      document.getElementById('completeJobModal').classList.remove('open');
    }

    // Submit job completion
    async function submitJobCompletion() {
      if (!activeJobData) return;

      // Get selected calibrations
      const checkboxes = document.querySelectorAll('#completeCalibrationsContainer input[type="checkbox"]:checked');
      const completedCals = Array.from(checkboxes).map(cb => cb.value);
      const notes = document.getElementById('completeJobNotes').value.trim();

      try {
        showLoading('Completing job...');

        const token = getStorageItem('adas_access_token') || getStorageItem('token');
        const response = await fetch('/api/tech/complete-job', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            roPo: activeJobData.roPo,
            completedCalibrations: completedCals.join(', '),
            notes: notes
          })
        });

        const data = await response.json();
        hideLoading();

        if (!data.success) {
          showToast(data.error || 'Failed to complete job', 'error');
          return;
        }

        // Clear active job
        localStorage.removeItem(ACTIVE_JOB_STORAGE_KEY);
        activeJobData = null;

        hideActiveJobBanner();
        closeCompleteJobModal();
        await loadJobs();
        showToast('Job completed!', 'success');

      } catch (err) {
        hideLoading();
        showToast('Failed to complete job: ' + err.message, 'error');
      }
    }

    // Check if a job can be started (no other active job)
    function canStartJob(roPo) {
      if (!activeJobData) return true;
      return activeJobData.roPo === roPo;
    }

    // Helper functions
    function getStorageItem(key) {
      return localStorage.getItem(key) || sessionStorage.getItem(key);
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Loading overlay functions
    function showLoading(text = 'Processing...') {
      const overlay = document.getElementById('loadingOverlay');
      const textEl = document.getElementById('loadingText');
      if (textEl) textEl.textContent = text;
      if (overlay) overlay.classList.add('active');
    }

    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.classList.remove('active');
    }

    // Toast notification functions
    function showToast(message, type = 'info', duration = 3500) {
      const container = document.getElementById('toastContainer');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      let iconSvg = Icons.info || '';
      if (type === 'success') iconSvg = Icons.checkCircle || '';
      else if (type === 'error') iconSvg = Icons.alertCircle || Icons.x || '';

      toast.innerHTML = `
        <span class="icon">${iconSvg}</span>
        <span>${escapeHtml(message)}</span>
      `;

      container.appendChild(toast);

      // Trigger animation
      requestAnimationFrame(() => {
        toast.classList.add('show');
      });

      // Auto dismiss
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      // Check auth
      const token = getStorageItem('adas_access_token') || getStorageItem('token');
      const role = getStorageItem('adas_user_role') || getStorageItem('userRole');

      if (!token) {
        window.location.replace('/?logout=true');
        return;
      }

      if (role !== 'tech') {
        localStorage.clear();
        sessionStorage.clear();
        window.location.replace('/?logout=true');
        return;
      }

      // Get tech name
      currentTechName = getStorageItem('userName') || 'Technician';
      document.getElementById('techName').textContent = `Welcome, ${currentTechName}`;

      // Initialize icons
      initIcons();

      // Setup logout
      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.clear();
        sessionStorage.clear();
        window.location.replace('/?logout=true');
      });

      // Check for active job and load jobs
      await checkActiveJob();
      await loadJobs();

      // Auto-refresh every 10 seconds
      setInterval(async () => {
        try {
          await loadJobs();
          await checkActiveJob();
          updateLastRefreshIndicator();
          console.log('[AUTO_REFRESH] Data refreshed');
        } catch (err) {
          console.warn('[AUTO_REFRESH] Failed:', err.message);
        }
      }, 10000);
    });

    function initIcons() {
      document.getElementById('logoutIcon').innerHTML = Icons.logout;
      document.getElementById('closeModalIcon').innerHTML = Icons.x;
      document.getElementById('allJobsToggle').innerHTML = Icons.chevronRight;
      document.getElementById('viewOnlyIcon').innerHTML = Icons.eye;
      document.getElementById('prevWeekIcon').innerHTML = Icons.chevronLeft || '&larr;';
      document.getElementById('nextWeekIcon').innerHTML = Icons.chevronRight || '&rarr;';
      // Active job banner icons
      document.getElementById('activeJobIcon').innerHTML = Icons.wrench || Icons.tool || 'ðŸ”§';
      document.getElementById('completeBannerIcon').innerHTML = Icons.checkCircle || 'âœ“';
      // Complete job modal icons
      document.getElementById('closeCompleteIcon').innerHTML = Icons.x;
      document.getElementById('submitCompleteIcon').innerHTML = Icons.checkCircle || 'âœ“';
    }

    // Track last refresh time
    let lastRefreshTime = Date.now();

    function updateLastRefreshIndicator() {
      lastRefreshTime = Date.now();
      const el = document.getElementById('lastRefreshIndicator');
      if (el) el.textContent = 'Updated just now';
    }

    // Update indicator every second to show elapsed time
    setInterval(() => {
      const el = document.getElementById('lastRefreshIndicator');
      if (!el) return;
      const seconds = Math.floor((Date.now() - lastRefreshTime) / 1000);
      if (seconds < 5) {
        el.textContent = 'Updated just now';
      } else if (seconds < 60) {
        el.textContent = `Updated ${seconds}s ago`;
      } else {
        el.textContent = `Updated ${Math.floor(seconds / 60)}m ago`;
      }
    }, 1000);

    async function loadJobs() {
      try {
        const token = getStorageItem('adas_access_token') || getStorageItem('token');
        const response = await fetch('/api/tech/vehicles', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        allJobs = data.vehicles || [];

        // Split into my jobs vs other jobs
        const techNameLower = currentTechName.toLowerCase().trim();
        myJobs = allJobs.filter(j => {
          const jobTech = (j.technician || j.technicianAssigned || '').toLowerCase().trim();
          return jobTech === techNameLower;
        });
        otherJobs = allJobs.filter(j => {
          const jobTech = (j.technician || j.technicianAssigned || '').toLowerCase().trim();
          return jobTech !== techNameLower;
        });

        renderYourJobs();
        renderAllJobs();
        renderCalendar();

      } catch (err) {
        console.error('Load error:', err);
        document.getElementById('needsRevvList').innerHTML = '<div class="empty-state"><p>Failed to load jobs</p></div>';
      }
    }

    function renderYourJobs() {
      const today = new Date().toDateString();

      // Filter into categories
      const needsRevv = myJobs.filter(j => {
        const status = (j.status || '').toLowerCase();
        const hasRevv = j.revvReportUrl || j.revvPdf || j.revv_pdf || j.revvReportPdf;
        return !hasRevv && status !== 'completed' && status !== 'cancelled';
      });

      const todayJobs = myJobs.filter(j => {
        if (!j.scheduledDate) return false;
        const jobDate = new Date(j.scheduledDate).toDateString();
        const status = (j.status || '').toLowerCase();
        return jobDate === today && status !== 'completed';
      });

      const inProgress = myJobs.filter(j => {
        const status = (j.status || '').toLowerCase();
        return status === 'in progress';
      });

      // Update counts
      document.getElementById('yourJobsCount').textContent = myJobs.length;

      // Render Needs RevvADAS
      if (needsRevv.length === 0) {
        document.getElementById('needsRevvSection').style.display = 'none';
      } else {
        document.getElementById('needsRevvSection').style.display = 'block';
        document.getElementById('needsRevvList').innerHTML = needsRevv.map(j => renderJobRow(j, 'needs-action', 'red')).join('');
      }

      // Render Today
      if (todayJobs.length === 0) {
        document.getElementById('todayList').innerHTML = `
          <div class="empty-state">
            <span class="icon">${Icons.calendar}</span>
            <p>No jobs scheduled for today</p>
          </div>
        `;
      } else {
        document.getElementById('todayList').innerHTML = todayJobs.map(j => {
          const status = (j.status || '').toLowerCase();
          const colorClass = status === 'in progress' ? 'in-progress' : 'scheduled';
          const dotColor = status === 'in progress' ? 'purple' : 'blue';
          return renderJobRow(j, colorClass, dotColor);
        }).join('');
      }

      // Render In Progress
      if (inProgress.length === 0) {
        document.getElementById('inProgressSection').style.display = 'none';
      } else {
        document.getElementById('inProgressSection').style.display = 'block';
        document.getElementById('inProgressList').innerHTML = inProgress.map(j => renderJobRow(j, 'in-progress', 'purple')).join('');
      }
    }

    function renderAllJobs() {
      document.getElementById('allJobsCount').textContent = otherJobs.length;

      if (otherJobs.length === 0) {
        document.getElementById('allJobsList').innerHTML = `
          <div class="empty-state">
            <span class="icon">${Icons.checkCircle}</span>
            <p>No other jobs available</p>
          </div>
        `;
      } else {
        document.getElementById('allJobsList').innerHTML = otherJobs.map(j => renderJobRow(j, 'view-only', 'gray', true)).join('');
      }
    }

    function renderJobRow(job, statusClass, dotColor, viewOnly = false) {
      const roPo = escapeHtml(job.roPo || '');
      const shop = escapeHtml(job.shopName || 'Unknown Shop');
      const vehicle = escapeHtml(job.vehicle || 'Unknown Vehicle');
      const time = job.scheduledTime || '';
      const status = job.status || 'New';

      let badgeClass = 'scheduled';
      let badgeText = status;
      if (statusClass === 'needs-action') {
        badgeClass = 'needs-revv';
        badgeText = 'Needs Revv';
      } else if (statusClass === 'in-progress') {
        badgeClass = 'in-progress';
        badgeText = 'In Progress';
      } else if (statusClass === 'completed') {
        badgeClass = 'completed';
        badgeText = 'Completed';
      } else if (viewOnly) {
        badgeClass = 'view-only';
        badgeText = job.technician || job.technicianAssigned || 'Unassigned';
      }

      return `
        <div class="job-row ${statusClass}" onclick="openModal('${roPo}', ${viewOnly})">
          <div class="job-status-indicator ${dotColor}"></div>
          <div class="job-info">
            <div class="job-ro">RO #${roPo}</div>
            <div class="job-details">${shop} - ${vehicle}</div>
          </div>
          <div class="job-meta">
            ${time ? `<span class="job-time">${escapeHtml(time)}</span>` : ''}
            <span class="job-badge ${badgeClass}">${escapeHtml(badgeText)}</span>
            <span class="job-arrow">${Icons.chevronRight}</span>
          </div>
        </div>
      `;
    }

    function toggleAllJobs() {
      const section = document.getElementById('allJobsSection');
      const toggle = document.getElementById('allJobsToggle');

      isAllJobsExpanded = !isAllJobsExpanded;

      if (isAllJobsExpanded) {
        section.classList.add('expanded');
        toggle.style.transform = 'rotate(90deg)';
      } else {
        section.classList.remove('expanded');
        toggle.style.transform = 'rotate(0deg)';
      }
    }

    function openModal(roPo, viewOnly) {
      currentJob = allJobs.find(j => j.roPo === roPo);
      if (!currentJob) return;

      // Reset upload states
      selectedCalibrations = {};
      uploadedRevvFile = null;
      uploadedInvoiceFile = null;
      uploadedPostScanFile = null;

      document.getElementById('modalTitle').textContent = `RO #${currentJob.roPo}`;

      // Render modal content based on status
      const modalBody = document.getElementById('modalBody');
      const status = (currentJob.status || 'New').toLowerCase();
      const hasRevv = currentJob.revvReportUrl || currentJob.revvPdf || currentJob.revv_pdf || currentJob.revvReportPdf;

      // Determine effective status for UI
      let effectiveStatus = status;
      if (status === 'new' && !hasRevv) effectiveStatus = 'new';
      else if (status === 'ready' || (status === 'new' && hasRevv)) effectiveStatus = 'ready';

      if (viewOnly) {
        modalBody.innerHTML = renderViewOnlyModal();
      } else if (effectiveStatus === 'new') {
        modalBody.innerHTML = renderNewStatusModal();
        initCalibrationHandlers();
        initRevvUploadHandler();
      } else if (effectiveStatus === 'ready') {
        modalBody.innerHTML = renderReadyStatusModal();
      } else if (effectiveStatus === 'scheduled' || effectiveStatus === 'rescheduled') {
        modalBody.innerHTML = renderScheduledStatusModal();
      } else if (effectiveStatus === 'in progress') {
        modalBody.innerHTML = renderInProgressStatusModal();
        initInProgressUploadHandlers();
      } else if (effectiveStatus === 'completed') {
        modalBody.innerHTML = renderCompletedStatusModal();
      } else {
        modalBody.innerHTML = renderDefaultModal();
      }

      document.getElementById('jobModal').classList.add('open');
    }

    function renderVehicleInfoSection() {
      const status = currentJob.status || 'New';
      let statusClass = 'new';
      if (status.toLowerCase() === 'ready') statusClass = 'ready';
      else if (status.toLowerCase() === 'scheduled' || status.toLowerCase() === 'rescheduled') statusClass = 'scheduled';
      else if (status.toLowerCase() === 'in progress') statusClass = 'in-progress';
      else if (status.toLowerCase() === 'completed') statusClass = 'completed';

      let scheduleText = 'Not scheduled';
      if (currentJob.scheduledDate) {
        const date = new Date(currentJob.scheduledDate).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        scheduleText = currentJob.scheduledTime ? `${date} at ${currentJob.scheduledTime}` : date;
      }

      return `
        <div class="modal-section">
          <h4>Vehicle Information</h4>
          <div class="info-row">
            <span class="info-label">Shop</span>
            <span class="info-value">${escapeHtml(currentJob.shopName || '-')}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Vehicle</span>
            <span class="info-value">${escapeHtml(currentJob.vehicle || '-')}</span>
          </div>
          <div class="info-row">
            <span class="info-label">VIN</span>
            <span class="info-value mono">${escapeHtml(currentJob.vin || '-')}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Status</span>
            <span class="status-badge-inline ${statusClass}">${escapeHtml(status)}</span>
          </div>
          ${currentJob.scheduledDate ? `
          <div class="info-row">
            <span class="info-label">Scheduled</span>
            <span class="info-value">${escapeHtml(scheduleText)}</span>
          </div>
          ` : ''}
        </div>
      `;
    }

    function renderDocumentsSection(showDocs = ['estimate', 'prescan']) {
      const docs = {
        estimate: { name: 'Estimate', url: currentJob.estimatePdf || currentJob.estimate_pdf || currentJob.estimatePdfUrl },
        prescan: { name: 'Pre-Scan', url: currentJob.prescanPdf || currentJob.preScanPdf || currentJob.preScanPdfUrl, noDtcConfirm: currentJob.noDtcConfirm },
        revv: { name: 'RevvADAS Report', url: currentJob.revvPdf || currentJob.revvReportPdf || currentJob.revvReportUrl },
        postscan: { name: 'Post-Scan', url: currentJob.postscanPdf || currentJob.postScanPdf || currentJob.postScanPdfUrl },
        invoice: { name: 'Invoice', url: currentJob.invoicePdf || currentJob.invoice_pdf || currentJob.invoicePdfUrl }
      };

      const docItems = showDocs.map(key => {
        const doc = docs[key];
        if (!doc) return '';

        const hasUrl = doc.url && doc.url.startsWith('http');
        let statusText = 'Not uploaded';
        if (hasUrl) statusText = 'View';
        else if (key === 'prescan' && doc.noDtcConfirm) statusText = 'No DTCs confirmed';

        if (hasUrl) {
          return `
            <a href="${doc.url}" target="_blank" class="doc-item available">
              <span class="icon">${Icons.file}</span>
              <span class="doc-name">${doc.name}</span>
              <span class="doc-status">${statusText}</span>
            </a>
          `;
        } else {
          return `
            <div class="doc-item">
              <span class="icon">${Icons.file}</span>
              <span class="doc-name">${doc.name}</span>
              <span class="doc-status">${statusText}</span>
            </div>
          `;
        }
      }).join('');

      return `
        <div class="modal-section">
          <h4>Documents</h4>
          <div class="doc-grid">
            ${docItems}
          </div>
        </div>
      `;
    }

    function renderNewStatusModal() {
      return `
        ${renderVehicleInfoSection()}
        ${renderDocumentsSection(['estimate', 'prescan'])}

        <div class="modal-section">
          <h4>Upload RevvADAS Report</h4>
          <div class="upload-zone" id="revvUploadZone">
            <input type="file" id="revvFileInput" accept=".pdf">
            <span class="icon">${Icons.upload}</span>
            <p>Drag & drop RevvADAS PDF here or click to browse</p>
            <p class="filename" id="revvFileName" style="display:none;"></p>
          </div>
        </div>

        <div class="modal-section">
          <h4>Calibrations Required</h4>
          <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;">Select all calibrations that apply based on the RevvADAS report:</p>

          <div class="calibration-grid">
            <div class="calibration-item" data-cal="forward-camera">
              <input type="checkbox" id="cal-forward-camera">
              <div class="cal-content">
                <div class="cal-name">Forward Camera</div>
                <div class="cal-options">
                  <label class="cal-option"><input type="radio" name="forward-camera-type" value="Static"> Static</label>
                  <label class="cal-option"><input type="radio" name="forward-camera-type" value="Dynamic"> Dynamic</label>
                  <label class="cal-option"><input type="radio" name="forward-camera-type" value="Both"> Both</label>
                </div>
              </div>
            </div>

            <div class="calibration-item" data-cal="front-radar">
              <input type="checkbox" id="cal-front-radar">
              <div class="cal-content">
                <div class="cal-name">Front Radar</div>
                <div class="cal-options">
                  <label class="cal-option"><input type="radio" name="front-radar-type" value="Static"> Static</label>
                  <label class="cal-option"><input type="radio" name="front-radar-type" value="Dynamic"> Dynamic</label>
                  <label class="cal-option"><input type="radio" name="front-radar-type" value="Both"> Both</label>
                </div>
              </div>
            </div>

            <div class="calibration-item" data-cal="rear-radar">
              <input type="checkbox" id="cal-rear-radar">
              <div class="cal-content">
                <div class="cal-name">Rear Radar</div>
                <div class="cal-options">
                  <label class="cal-option"><input type="radio" name="rear-radar-type" value="Static"> Static</label>
                  <label class="cal-option"><input type="radio" name="rear-radar-type" value="Dynamic"> Dynamic</label>
                  <label class="cal-option"><input type="radio" name="rear-radar-type" value="Both"> Both</label>
                </div>
              </div>
            </div>

            <div class="calibration-item" data-cal="blind-spot-left">
              <input type="checkbox" id="cal-blind-spot-left">
              <div class="cal-content">
                <div class="cal-name">Blind Spot Left</div>
                <div class="cal-fixed">(Static calibration)</div>
              </div>
            </div>

            <div class="calibration-item" data-cal="blind-spot-right">
              <input type="checkbox" id="cal-blind-spot-right">
              <div class="cal-content">
                <div class="cal-name">Blind Spot Right</div>
                <div class="cal-fixed">(Static calibration)</div>
              </div>
            </div>

            <div class="calibration-item" data-cal="360-camera">
              <input type="checkbox" id="cal-360-camera">
              <div class="cal-content">
                <div class="cal-name">360 Camera</div>
                <div class="cal-fixed">(Static calibration)</div>
              </div>
            </div>

            <div class="other-calibration">
              <input type="checkbox" id="cal-other">
              <span style="font-size:14px;color:var(--text-secondary);">Other:</span>
              <input type="text" id="cal-other-text" placeholder="Specify calibration...">
            </div>
          </div>

          <div class="no-cal-option">
            <input type="checkbox" id="cal-none">
            <div class="no-cal-content">
              <div class="no-cal-label">No Calibration Required</div>
              <div class="no-cal-hint">Does this vehicle need action tests or system resets? (Common for Nissan rear radar) If yes, select the calibration above.</div>
            </div>
          </div>
        </div>

        <div class="modal-section">
          <div class="action-buttons">
            <button class="btn btn-primary" id="submitRevvBtn" onclick="submitRevvReport()">
              <span class="icon">${Icons.upload}</span>
              Submit RevvADAS Report
            </button>
          </div>
        </div>
      `;
    }

    function renderReadyStatusModal() {
      const cals = currentJob.requiredCalibrations || 'Not determined';

      return `
        ${renderVehicleInfoSection()}

        <div class="modal-section">
          <h4>Required Calibrations</h4>
          <div class="calibrations-box">${escapeHtml(cals)}</div>
        </div>

        ${renderDocumentsSection(['estimate', 'prescan', 'revv'])}

        <div class="modal-section">
          <div class="waiting-message">
            <span class="icon">${Icons.clock}</span>
            <span>Waiting for shop to schedule this job</span>
          </div>
        </div>
      `;
    }

    function renderScheduledStatusModal() {
      const cals = currentJob.requiredCalibrations || 'Not determined';
      const canStart = canStartJob(currentJob.roPo);
      const isActiveJob = activeJobData && activeJobData.roPo === currentJob.roPo;

      return `
        ${renderVehicleInfoSection()}

        <div class="modal-section">
          <h4>Required Calibrations</h4>
          <div class="calibrations-box">${escapeHtml(cals)}</div>
        </div>

        ${renderDocumentsSection(['estimate', 'prescan', 'revv'])}

        <div class="modal-section">
          ${!canStart ? `
            <div class="start-blocked-message">
              <span class="icon">${Icons.alertCircle || 'âš ï¸'}</span>
              <span>Complete your current job first (RO #${activeJobData?.roPo})</span>
            </div>
          ` : ''}
          <div class="action-buttons">
            <button class="btn btn-start ${!canStart ? 'disabled-job' : ''}"
                    onclick="${canStart ? `startJobAction('${currentJob.roPo}')` : ''}"
                    ${!canStart ? 'disabled' : ''}>
              <span class="icon">${Icons.wrench}</span>
              ${isActiveJob ? 'Job In Progress' : 'Start Job'}
            </button>
          </div>
        </div>
      `;
    }

    function renderInProgressStatusModal() {
      const cals = currentJob.requiredCalibrations || 'Not determined';
      const hasInvoice = currentJob.invoicePdf || currentJob.invoice_pdf || currentJob.invoicePdfUrl;
      const hasPostScan = currentJob.postscanPdf || currentJob.postScanPdf || currentJob.postScanPdfUrl;
      const canComplete = hasInvoice && hasPostScan;

      return `
        ${renderVehicleInfoSection()}

        <div class="modal-section">
          <h4>Required Calibrations</h4>
          <div class="calibrations-box">${escapeHtml(cals)}</div>
        </div>

        ${renderDocumentsSection(['estimate', 'prescan', 'revv'])}

        <div class="modal-section">
          <h4>Upload Invoice</h4>
          ${hasInvoice ? `
            <a href="${currentJob.invoicePdf || currentJob.invoice_pdf || currentJob.invoicePdfUrl}" target="_blank" class="doc-item available" style="display:inline-flex;width:auto;">
              <span class="icon">${Icons.file}</span>
              <span class="doc-name">Invoice</span>
              <span class="doc-status">Uploaded</span>
            </a>
          ` : `
            <div class="upload-zone" id="invoiceUploadZone">
              <input type="file" id="invoiceFileInput" accept=".pdf">
              <span class="icon">${Icons.upload}</span>
              <p>Upload Invoice PDF</p>
              <p class="filename" id="invoiceFileName" style="display:none;"></p>
            </div>
          `}
        </div>

        <div class="modal-section">
          <h4>Upload Post-Scan</h4>
          ${hasPostScan ? `
            <a href="${currentJob.postscanPdf || currentJob.postScanPdf || currentJob.postScanPdfUrl}" target="_blank" class="doc-item available" style="display:inline-flex;width:auto;">
              <span class="icon">${Icons.file}</span>
              <span class="doc-name">Post-Scan</span>
              <span class="doc-status">Uploaded</span>
            </a>
          ` : `
            <div class="upload-zone" id="postScanUploadZone">
              <input type="file" id="postScanFileInput" accept=".pdf">
              <span class="icon">${Icons.upload}</span>
              <p>Upload Post-Scan PDF</p>
              <p class="filename" id="postScanFileName" style="display:none;"></p>
            </div>
          `}
        </div>

        <div class="modal-section">
          <div class="action-buttons">
            <button class="btn btn-complete ${canComplete ? '' : 'btn-disabled'}" ${canComplete ? 'onclick="updateStatus(\'Completed\')"' : 'disabled'}>
              <span class="icon">${Icons.checkCircle}</span>
              ${canComplete ? 'Complete Job' : 'Upload Invoice & Post-Scan to Complete'}
            </button>
          </div>
        </div>
      `;
    }

    function renderCompletedStatusModal() {
      const cals = currentJob.requiredCalibrations || '-';

      return `
        ${renderVehicleInfoSection()}

        <div class="modal-section">
          <h4>Calibrations Performed</h4>
          <div class="calibrations-box">${escapeHtml(cals)}</div>
        </div>

        ${renderDocumentsSection(['estimate', 'prescan', 'revv', 'invoice', 'postscan'])}

        <div class="modal-section">
          <div class="completion-info">
            <div class="info-row">
              <span class="info-label">Completed</span>
              <span class="info-value">${Icons.checkCircle} Job Complete</span>
            </div>
          </div>
        </div>
      `;
    }

    function renderViewOnlyModal() {
      const tech = currentJob.technician || currentJob.technicianAssigned || 'another technician';
      const cals = currentJob.requiredCalibrations || 'Not determined';

      return `
        <div class="view-only-banner">
          <span class="icon">${Icons.eye}</span>
          <span>Assigned to ${escapeHtml(tech)} (view only)</span>
        </div>

        ${renderVehicleInfoSection()}

        <div class="modal-section">
          <h4>Required Calibrations</h4>
          <div class="calibrations-box">${escapeHtml(cals)}</div>
        </div>

        ${renderDocumentsSection(['estimate', 'prescan', 'revv', 'invoice', 'postscan'])}
      `;
    }

    function renderDefaultModal() {
      return `
        ${renderVehicleInfoSection()}
        ${renderDocumentsSection(['estimate', 'prescan', 'revv', 'invoice', 'postscan'])}
      `;
    }

    function initCalibrationHandlers() {
      // Handle checkbox selection styling
      document.querySelectorAll('.calibration-item input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const item = this.closest('.calibration-item');
          if (this.checked) {
            item.classList.add('selected');
          } else {
            item.classList.remove('selected');
          }
        });
      });

      // Handle "No Calibration" exclusivity
      const noCalCheckbox = document.getElementById('cal-none');
      if (noCalCheckbox) {
        noCalCheckbox.addEventListener('change', function() {
          if (this.checked) {
            document.querySelectorAll('.calibration-item input[type="checkbox"]').forEach(cb => {
              cb.checked = false;
              cb.closest('.calibration-item').classList.remove('selected');
            });
            document.getElementById('cal-other').checked = false;
          }
        });

        // Uncheck "No Calibration" if any calibration is selected
        document.querySelectorAll('.calibration-item input[type="checkbox"], #cal-other').forEach(checkbox => {
          checkbox.addEventListener('change', function() {
            if (this.checked) {
              noCalCheckbox.checked = false;
            }
          });
        });
      }
    }

    function initRevvUploadHandler() {
      const zone = document.getElementById('revvUploadZone');
      const input = document.getElementById('revvFileInput');
      const fileName = document.getElementById('revvFileName');

      if (!zone || !input) return;

      zone.addEventListener('click', () => input.click());

      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('dragover');
      });

      zone.addEventListener('dragleave', () => {
        zone.classList.remove('dragover');
      });

      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
          handleRevvFile(e.dataTransfer.files[0]);
        }
      });

      input.addEventListener('change', () => {
        if (input.files.length) {
          handleRevvFile(input.files[0]);
        }
      });

      function handleRevvFile(file) {
        if (!file.name.toLowerCase().endsWith('.pdf')) {
          showToast('Please upload a PDF file', 'error');
          return;
        }
        uploadedRevvFile = file;
        fileName.textContent = file.name;
        fileName.style.display = 'block';
        zone.querySelector('p:not(.filename)').textContent = 'File selected:';
      }
    }

    function initInProgressUploadHandlers() {
      // Invoice upload
      const invoiceZone = document.getElementById('invoiceUploadZone');
      const invoiceInput = document.getElementById('invoiceFileInput');

      if (invoiceZone && invoiceInput) {
        invoiceZone.addEventListener('click', () => invoiceInput.click());

        invoiceZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          invoiceZone.classList.add('dragover');
        });

        invoiceZone.addEventListener('dragleave', () => {
          invoiceZone.classList.remove('dragover');
        });

        invoiceZone.addEventListener('drop', (e) => {
          e.preventDefault();
          invoiceZone.classList.remove('dragover');
          if (e.dataTransfer.files.length) {
            handleInvoiceFile(e.dataTransfer.files[0]);
          }
        });

        invoiceInput.addEventListener('change', () => {
          if (invoiceInput.files.length) {
            handleInvoiceFile(invoiceInput.files[0]);
          }
        });
      }

      // Post-scan upload
      const postScanZone = document.getElementById('postScanUploadZone');
      const postScanInput = document.getElementById('postScanFileInput');

      if (postScanZone && postScanInput) {
        postScanZone.addEventListener('click', () => postScanInput.click());

        postScanZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          postScanZone.classList.add('dragover');
        });

        postScanZone.addEventListener('dragleave', () => {
          postScanZone.classList.remove('dragover');
        });

        postScanZone.addEventListener('drop', (e) => {
          e.preventDefault();
          postScanZone.classList.remove('dragover');
          if (e.dataTransfer.files.length) {
            handlePostScanFile(e.dataTransfer.files[0]);
          }
        });

        postScanInput.addEventListener('change', () => {
          if (postScanInput.files.length) {
            handlePostScanFile(postScanInput.files[0]);
          }
        });
      }

      async function handleInvoiceFile(file) {
        if (!file.name.toLowerCase().endsWith('.pdf')) {
          showToast('Please upload a PDF file', 'error');
          return;
        }

        const fileName = document.getElementById('invoiceFileName');
        if (fileName) {
          fileName.textContent = file.name;
          fileName.style.display = 'block';
        }

        // Upload immediately
        await uploadDocument(file, 'invoice');
      }

      async function handlePostScanFile(file) {
        if (!file.name.toLowerCase().endsWith('.pdf')) {
          showToast('Please upload a PDF file', 'error');
          return;
        }

        const fileName = document.getElementById('postScanFileName');
        if (fileName) {
          fileName.textContent = file.name;
          fileName.style.display = 'block';
        }

        // Upload immediately
        await uploadDocument(file, 'postscan');
      }
    }

    async function uploadDocument(file, type) {
      if (!currentJob) return;

      // Map frontend type names to backend docType names
      const typeMap = {
        'invoice': 'invoice',
        'postscan': 'postScan',
        'revv': 'revvReport',
        'revvReport': 'revvReport'
      };
      const docType = typeMap[type] || type;

      try {
        const formData = new FormData();
        // IMPORTANT: Text fields MUST come BEFORE file for multer to parse them correctly
        formData.append('docType', docType);
        formData.append('file', file);

        const token = getStorageItem('adas_access_token') || getStorageItem('token');
        const response = await fetch(`/api/tech/vehicles/${currentJob.roPo}/upload`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        // Refresh the job data and re-render modal
        await loadJobs();
        currentJob = allJobs.find(j => j.roPo === currentJob.roPo);
        if (currentJob) {
          const modalBody = document.getElementById('modalBody');
          modalBody.innerHTML = renderInProgressStatusModal();
          initInProgressUploadHandlers();
        }

      } catch (err) {
        showToast('Failed to upload: ' + err.message, 'error');
      }
    }

    function getSelectedCalibrations() {
      const calibrations = [];

      // Check each calibration type
      const calTypes = [
        { id: 'forward-camera', name: 'Forward Camera', hasOptions: true },
        { id: 'front-radar', name: 'Front Radar', hasOptions: true },
        { id: 'rear-radar', name: 'Rear Radar', hasOptions: true },
        { id: 'blind-spot-left', name: 'Blind Spot Left', hasOptions: false, type: 'Static' },
        { id: 'blind-spot-right', name: 'Blind Spot Right', hasOptions: false, type: 'Static' },
        { id: '360-camera', name: '360 Camera', hasOptions: false, type: 'Static' }
      ];

      calTypes.forEach(cal => {
        const checkbox = document.getElementById(`cal-${cal.id}`);
        if (checkbox && checkbox.checked) {
          if (cal.hasOptions) {
            const selectedOption = document.querySelector(`input[name="${cal.id}-type"]:checked`);
            const type = selectedOption ? selectedOption.value : '';
            calibrations.push(`${cal.name} (${type})`);
          } else {
            calibrations.push(`${cal.name} (${cal.type})`);
          }
        }
      });

      // Check "Other"
      const otherCheckbox = document.getElementById('cal-other');
      const otherText = document.getElementById('cal-other-text');
      if (otherCheckbox && otherCheckbox.checked && otherText && otherText.value.trim()) {
        calibrations.push(otherText.value.trim());
      }

      // Check "No Calibration"
      const noCalCheckbox = document.getElementById('cal-none');
      if (noCalCheckbox && noCalCheckbox.checked) {
        return ['No Calibration Required'];
      }

      return calibrations;
    }

    async function submitRevvReport() {
      if (!currentJob) return;

      const calibrations = getSelectedCalibrations();

      if (!uploadedRevvFile) {
        showToast('Please upload a RevvADAS PDF file', 'error');
        return;
      }

      if (calibrations.length === 0) {
        showToast('Please select at least one calibration or "No Calibration Required"', 'error');
        return;
      }

      // Validate calibration options
      const calTypes = ['forward-camera', 'front-radar', 'rear-radar'];
      for (const calType of calTypes) {
        const checkbox = document.getElementById(`cal-${calType}`);
        if (checkbox && checkbox.checked) {
          const selectedOption = document.querySelector(`input[name="${calType}-type"]:checked`);
          if (!selectedOption) {
            showToast(`Please select Static, Dynamic, or Both for ${calType.replace(/-/g, ' ')}`, 'error');
            return;
          }
        }
      }

      try {
        const btn = document.getElementById('submitRevvBtn');
        btn.disabled = true;
        btn.innerHTML = `<span class="icon">${Icons.loader}</span> Submitting...`;

        // Show loading overlay
        showLoading('Uploading RevvADAS report...');

        const formData = new FormData();
        // IMPORTANT: Text fields MUST come BEFORE file for multer to parse them correctly
        formData.append('docType', 'revvReport');
        formData.append('calibrations', calibrations.join(', '));
        formData.append('file', uploadedRevvFile);

        // Debug logging
        console.log('[TECH] Uploading RevvADAS:', {
          roPo: currentJob.roPo,
          docType: 'revvReport',
          fileName: uploadedRevvFile.name,
          calibrations: calibrations.join(', ')
        });

        const token = getStorageItem('adas_access_token') || getStorageItem('token');
        const url = `/api/tech/vehicles/${currentJob.roPo}/upload`;
        console.log('[TECH] Upload URL:', url);

        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        console.log('[TECH] Upload response status:', response.status);
        const data = await response.json();
        console.log('[TECH] Upload response data:', data);
        if (!data.success) throw new Error(data.error);

        hideLoading();
        closeModal();
        await loadJobs();
        showToast('RevvADAS report submitted successfully!', 'success');

      } catch (err) {
        hideLoading();
        showToast('Failed to submit: ' + err.message, 'error');
        const btn = document.getElementById('submitRevvBtn');
        btn.disabled = false;
        btn.innerHTML = `<span class="icon">${Icons.upload}</span> Submit RevvADAS Report`;
      }
    }

    function closeModal() {
      document.getElementById('jobModal').classList.remove('open');
      currentJob = null;
      uploadedRevvFile = null;
      uploadedInvoiceFile = null;
      uploadedPostScanFile = null;
    }

    async function updateStatus(newStatus) {
      if (!currentJob) return;

      try {
        const token = getStorageItem('adas_access_token') || getStorageItem('token');
        const response = await fetch(`/api/tech/vehicles/${currentJob.roPo}/status`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: newStatus })
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        closeModal();
        await loadJobs();
      } catch (err) {
        showToast('Failed to update status: ' + err.message, 'error');
      }
    }

    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    // Close on backdrop click
    document.getElementById('jobModal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) closeModal();
    });
  </script>
</body>
</html>
